<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>키오스크 도우미</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }

        /* 카메라 컨테이너 */
        #camera-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        /* 비디오 스트림 */
        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 오버레이 캔버스 */
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* 안내 텍스트 박스 */
        .guide-box {
            position: absolute;
            background: rgba(255, 193, 7, 0.95);
            color: #000;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            border: 4px solid #ff5722;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            pointer-events: none;
            animation: pulse 2s infinite;
            max-width: 80%;
            line-height: 1.4;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 30px rgba(255, 87, 34, 0.6);
            }
        }

        /* 컨트롤 패널 */
        #control-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 2000;
        }

        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.stop {
            background: #f44336;
        }

        /* 로딩 인디케이터 */
        #loading {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 2000;
            display: none;
        }

        #loading.active {
            display: block;
        }

        /* 시작 화면 */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
        }

        #start-screen h1 {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
            padding: 0 20px;
        }

        #start-screen p {
            font-size: 18px;
            margin-bottom: 40px;
            text-align: center;
            padding: 0 30px;
            line-height: 1.6;
        }

        #start-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        #start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #start-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        /* 분석 상태 표시 */
        .analyzing-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: bold;
            z-index: 1500;
            animation: fadeInOut 2s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* 하이라이트 박스 */
        .highlight-box {
            position: absolute;
            border: 4px solid #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            pointer-events: none;
            z-index: 999;
            animation: highlight-pulse 1.5s infinite;
        }

        @keyframes highlight-pulse {
            0%, 100% {
                border-color: #4CAF50;
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            }
            50% {
                border-color: #8BC34A;
                box-shadow: 0 0 20px rgba(139, 195, 74, 0.8);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- 시작 화면 -->
    <div id="start-screen">
        <h1>🤖 키오스크 도우미</h1>
        <p>
            키오스크 화면을 카메라로 비추면<br>
            어떤 버튼을 눌러야 하는지<br>
            안내해드립니다
        </p>
        <p style="font-size: 14px; opacity: 0.9; margin-top: -20px; margin-bottom: 30px;">
            📸 시작 시 카메라 권한이 필요합니다
        </p>
        <button id="start-btn">시작하기</button>
    </div>

    <!-- 카메라 화면 -->
    <div id="camera-container" class="hidden">
        <video id="camera-stream" autoplay playsinline></video>
        <canvas id="overlay-canvas"></canvas>
    </div>

    <!-- 로딩 인디케이터 -->
    <div id="loading">분석 중...</div>

    <!-- 컨트롤 패널 -->
    <div id="control-panel" class="hidden">
        <button class="control-btn" id="analyze-btn">분석하기</button>
        <button class="control-btn stop" id="stop-btn">종료</button>
    </div>

    <script>
        // 전역 변수
        let videoStream = null;
        let isAnalyzing = false;
        let currentGuides = [];

        // DOM 요소
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const cameraContainer = document.getElementById('camera-container');
        const videoElement = document.getElementById('camera-stream');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const ctx = overlayCanvas.getContext('2d');
        const controlPanel = document.getElementById('control-panel');
        const analyzeBtn = document.getElementById('analyze-btn');
        const stopBtn = document.getElementById('stop-btn');
        const loading = document.getElementById('loading');

        // 시작 버튼 클릭
        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.textContent = '카메라 권한 요청 중...';
            
            const cameraGranted = await requestCameraPermission();
            
            if (cameraGranted) {
                await initializeCamera();
                startScreen.classList.add('hidden');
                cameraContainer.classList.remove('hidden');
                controlPanel.classList.remove('hidden');
            } else {
                startBtn.disabled = false;
                startBtn.textContent = '시작하기';
                alert('카메라 권한이 필요합니다.\n설정에서 카메라 권한을 허용해주세요.');
            }
        });

        // 카메라 권한 요청
        async function requestCameraPermission() {
            try {
                // 먼저 권한 상태 확인
                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    console.log('카메라 권한 상태:', permissionStatus.state);
                }

                // 카메라 접근 시도 (권한 요청)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment'
                    },
                    audio: false
                });

                // 권한 확인용으로만 사용하고 바로 종료
                stream.getTracks().forEach(track => track.stop());
                
                console.log('카메라 권한 허가됨');
                return true;

            } catch (error) {
                console.error('카메라 권한 거부:', error);
                return false;
            }
        }

        // 카메라 초기화
        async function initializeCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // 후면 카메라 사용
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;

                // 비디오 로드 후 캔버스 크기 조정
                videoElement.addEventListener('loadedmetadata', () => {
                    resizeCanvas();
                });

                // 화면 회전 시 캔버스 크기 재조정
                window.addEventListener('resize', resizeCanvas);
                window.addEventListener('orientationchange', resizeCanvas);

            } catch (error) {
                console.error('카메라 접근 오류:', error);
                alert('카메라에 접근할 수 없습니다. 권한을 확인해주세요.');
            }
        }

        // 캔버스 크기 조정
        function resizeCanvas() {
            overlayCanvas.width = videoElement.videoWidth || window.innerWidth;
            overlayCanvas.height = videoElement.videoHeight || window.innerHeight;
        }

        // 분석 버튼 클릭
        analyzeBtn.addEventListener('click', async () => {
            if (isAnalyzing) return;
            await analyzeKioskScreen();
        });

        // 키오스크 화면 분석
        async function analyzeKioskScreen() {
            isAnalyzing = true;
            loading.classList.add('active');
            analyzeBtn.textContent = '분석 중...';
            analyzeBtn.style.background = '#9E9E9E';

            try {
                // 현재 비디오 프레임 캡처
                const imageData = captureFrame();

                // AI 분석 수행 (데모용 - 실제로는 API 호출)
                const analysisResult = await performAIAnalysis(imageData);

                // 결과를 화면에 표시
                displayGuides(analysisResult);

            } catch (error) {
                console.error('분석 오류:', error);
                alert('분석 중 오류가 발생했습니다.');
            } finally {
                isAnalyzing = false;
                loading.classList.remove('active');
                analyzeBtn.textContent = '다시 분석';
                analyzeBtn.style.background = '#4CAF50';
            }
        }

        // 비디오 프레임 캡처
        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // AI 분석 수행 (데모 버전)
        async function performAIAnalysis(imageData) {
            // 실제 구현에서는 여기서 AI API를 호출합니다
            // 예: Claude API, Google Vision API, TensorFlow.js 등

            // 데모용 지연 시간
            await new Promise(resolve => setTimeout(resolve, 2000));

            // 데모용 더미 데이터
            // 실제로는 AI가 인식한 버튼의 위치와 텍스트를 반환
            return [
                {
                    type: 'button',
                    label: '주문하기',
                    confidence: 0.95,
                    bounds: {
                        x: 0.3, // 화면 비율 (0~1)
                        y: 0.7,
                        width: 0.4,
                        height: 0.15
                    },
                    guide: '메뉴 선택이 완료되었으면\n이 버튼을 눌러주세요'
                },
                {
                    type: 'button',
                    label: '메뉴판',
                    confidence: 0.88,
                    bounds: {
                        x: 0.1,
                        y: 0.3,
                        width: 0.35,
                        height: 0.25
                    },
                    guide: '원하시는 메뉴를\n여기서 선택하세요'
                },
                {
                    type: 'button',
                    label: '결제하기',
                    confidence: 0.92,
                    bounds: {
                        x: 0.55,
                        y: 0.3,
                        width: 0.35,
                        height: 0.25
                    },
                    guide: '주문이 끝나면\n이 버튼으로 결제하세요'
                }
            ];
        }

        // 안내 가이드 표시
        function displayGuides(results) {
            // 기존 가이드 제거
            clearGuides();

            const videoRect = videoElement.getBoundingClientRect();

            results.forEach((item, index) => {
                // 하이라이트 박스 생성
                const highlightBox = document.createElement('div');
                highlightBox.className = 'highlight-box';
                
                const x = item.bounds.x * videoRect.width;
                const y = item.bounds.y * videoRect.height;
                const width = item.bounds.width * videoRect.width;
                const height = item.bounds.height * videoRect.height;

                highlightBox.style.left = `${x}px`;
                highlightBox.style.top = `${y}px`;
                highlightBox.style.width = `${width}px`;
                highlightBox.style.height = `${height}px`;

                // 안내 텍스트 박스 생성
                const guideBox = document.createElement('div');
                guideBox.className = 'guide-box';
                guideBox.textContent = item.guide;
                guideBox.style.whiteSpace = 'pre-line';

                // 텍스트 박스 위치 (버튼 위쪽에 배치)
                let guideX = x + width / 2;
                let guideY = y - 10; // 버튼 위쪽

                // 화면 경계 체크
                guideBox.style.left = `${guideX}px`;
                guideBox.style.top = `${guideY}px`;
                guideBox.style.transform = 'translate(-50%, -100%)';

                // 애니메이션 지연
                guideBox.style.animationDelay = `${index * 0.2}s`;
                highlightBox.style.animationDelay = `${index * 0.2}s`;

                cameraContainer.appendChild(highlightBox);
                cameraContainer.appendChild(guideBox);

                currentGuides.push(highlightBox, guideBox);
            });
        }

        // 가이드 제거
        function clearGuides() {
            currentGuides.forEach(element => {
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            currentGuides = [];
        }

        // 종료 버튼
        stopBtn.addEventListener('click', () => {
            if (confirm('키오스크 도우미를 종료하시겠습니까?')) {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }
                clearGuides();
                cameraContainer.classList.add('hidden');
                controlPanel.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
        });

        // 자동 분석 모드 (선택사항)
        let autoAnalyzeInterval = null;
        
        function enableAutoAnalyze() {
            autoAnalyzeInterval = setInterval(async () => {
                if (!isAnalyzing) {
                    await analyzeKioskScreen();
                }
            }, 5000); // 5초마다 자동 분석
        }

        function disableAutoAnalyze() {
            if (autoAnalyzeInterval) {
                clearInterval(autoAnalyzeInterval);
                autoAnalyzeInterval = null;
            }
        }

        // 페이지 언로드 시 카메라 정리
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
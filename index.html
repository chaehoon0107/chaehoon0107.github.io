<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>í‚¤ì˜¤ìŠ¤í¬ ë„ìš°ë¯¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }

        /* ì¹´ë©”ë¼ ì»¨í…Œì´ë„ˆ */
        #camera-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000;
        }

        /* ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ */
        #camera-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ */
        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* ì•ˆë‚´ í…ìŠ¤íŠ¸ ë°•ìŠ¤ */
        .guide-box {
            position: absolute;
            background: rgba(255, 193, 7, 0.95);
            color: #000;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            border: 4px solid #ff5722;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            pointer-events: none;
            animation: pulse 2s infinite;
            max-width: 80%;
            line-height: 1.4;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 30px rgba(255, 87, 34, 0.6);
            }
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        #control-panel {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 2000;
        }

        .control-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        .control-btn.stop {
            background: #f44336;
        }

        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loading {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 2000;
            display: none;
        }

        #loading.active {
            display: block;
        }

        /* ì‹œì‘ í™”ë©´ */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
        }

        #start-screen h1 {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
            padding: 0 20px;
        }

        #start-screen p {
            font-size: 18px;
            margin-bottom: 40px;
            text-align: center;
            padding: 0 30px;
            line-height: 1.6;
        }

        #start-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        #start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #start-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .hidden {
            display: none !important;
        }

        /* ë¶„ì„ ìƒíƒœ í‘œì‹œ */
        .analyzing-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(76, 175, 80, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: bold;
            z-index: 1500;
            animation: fadeInOut 2s infinite;
        }

        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }

        /* í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤ */
        .highlight-box {
            position: absolute;
            border: 4px solid #4CAF50;
            background: rgba(76, 175, 80, 0.2);
            pointer-events: none;
            z-index: 999;
            animation: highlight-pulse 1.5s infinite;
        }

        @keyframes highlight-pulse {
            0%, 100% {
                border-color: #4CAF50;
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
            }
            50% {
                border-color: #8BC34A;
                box-shadow: 0 0 20px rgba(139, 195, 74, 0.8);
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- ì‹œì‘ í™”ë©´ -->
    <div id="start-screen">
        <h1>ğŸ¤– í‚¤ì˜¤ìŠ¤í¬ ë„ìš°ë¯¸</h1>
        <p>
            í‚¤ì˜¤ìŠ¤í¬ í™”ë©´ì„ ì¹´ë©”ë¼ë¡œ ë¹„ì¶”ë©´<br>
            ì–´ë–¤ ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•˜ëŠ”ì§€<br>
            ì•ˆë‚´í•´ë“œë¦½ë‹ˆë‹¤
        </p>
        <p style="font-size: 14px; opacity: 0.9; margin-top: -20px; margin-bottom: 30px;">
            ğŸ“¸ ì‹œì‘ ì‹œ ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤
        </p>
        <button id="start-btn">ì‹œì‘í•˜ê¸°</button>
    </div>

    <!-- ì¹´ë©”ë¼ í™”ë©´ -->
    <div id="camera-container" class="hidden">
        <video id="camera-stream" autoplay playsinline></video>
        <canvas id="overlay-canvas"></canvas>
    </div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° -->
    <div id="loading">ë¶„ì„ ì¤‘...</div>

    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div id="control-panel" class="hidden">
        <button class="control-btn" id="analyze-btn">ë¶„ì„í•˜ê¸°</button>
        <button class="control-btn stop" id="stop-btn">ì¢…ë£Œ</button>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let videoStream = null;
        let isAnalyzing = false;
        let currentGuides = [];

        // DOM ìš”ì†Œ
        const startScreen = document.getElementById('start-screen');
        const startBtn = document.getElementById('start-btn');
        const cameraContainer = document.getElementById('camera-container');
        const videoElement = document.getElementById('camera-stream');
        const overlayCanvas = document.getElementById('overlay-canvas');
        const ctx = overlayCanvas.getContext('2d');
        const controlPanel = document.getElementById('control-panel');
        const analyzeBtn = document.getElementById('analyze-btn');
        const stopBtn = document.getElementById('stop-btn');
        const loading = document.getElementById('loading');

        // ì‹œì‘ ë²„íŠ¼ í´ë¦­
        startBtn.addEventListener('click', async () => {
            startBtn.disabled = true;
            startBtn.textContent = 'ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...';
            
            const cameraGranted = await requestCameraPermission();
            
            if (cameraGranted) {
                await initializeCamera();
                startScreen.classList.add('hidden');
                cameraContainer.classList.remove('hidden');
                controlPanel.classList.remove('hidden');
            } else {
                startBtn.disabled = false;
                startBtn.textContent = 'ì‹œì‘í•˜ê¸°';
                alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\nì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­
        async function requestCameraPermission() {
            try {
                // ë¨¼ì € ê¶Œí•œ ìƒíƒœ í™•ì¸
                if (navigator.permissions) {
                    const permissionStatus = await navigator.permissions.query({ name: 'camera' });
                    console.log('ì¹´ë©”ë¼ ê¶Œí•œ ìƒíƒœ:', permissionStatus.state);
                }

                // ì¹´ë©”ë¼ ì ‘ê·¼ ì‹œë„ (ê¶Œí•œ ìš”ì²­)
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment'
                    },
                    audio: false
                });

                // ê¶Œí•œ í™•ì¸ìš©ìœ¼ë¡œë§Œ ì‚¬ìš©í•˜ê³  ë°”ë¡œ ì¢…ë£Œ
                stream.getTracks().forEach(track => track.stop());
                
                console.log('ì¹´ë©”ë¼ ê¶Œí•œ í—ˆê°€ë¨');
                return true;

            } catch (error) {
                console.error('ì¹´ë©”ë¼ ê¶Œí•œ ê±°ë¶€:', error);
                return false;
            }
        }

        // ì¹´ë©”ë¼ ì´ˆê¸°í™”
        async function initializeCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ì‚¬ìš©
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    },
                    audio: false
                };

                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                videoElement.srcObject = videoStream;

                // ë¹„ë””ì˜¤ ë¡œë“œ í›„ ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
                videoElement.addEventListener('loadedmetadata', () => {
                    resizeCanvas();
                });

                // í™”ë©´ íšŒì „ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì¡°ì •
                window.addEventListener('resize', resizeCanvas);
                window.addEventListener('orientationchange', resizeCanvas);

            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', error);
                alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
        function resizeCanvas() {
            overlayCanvas.width = videoElement.videoWidth || window.innerWidth;
            overlayCanvas.height = videoElement.videoHeight || window.innerHeight;
        }

        // ë¶„ì„ ë²„íŠ¼ í´ë¦­
        analyzeBtn.addEventListener('click', async () => {
            if (isAnalyzing) return;
            await analyzeKioskScreen();
        });

        // í‚¤ì˜¤ìŠ¤í¬ í™”ë©´ ë¶„ì„
        async function analyzeKioskScreen() {
            isAnalyzing = true;
            loading.classList.add('active');
            analyzeBtn.textContent = 'ë¶„ì„ ì¤‘...';
            analyzeBtn.style.background = '#9E9E9E';

            try {
                // í˜„ì¬ ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
                const imageData = captureFrame();

                // AI ë¶„ì„ ìˆ˜í–‰ (ë°ëª¨ìš© - ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ)
                const analysisResult = await performAIAnalysis(imageData);

                // ê²°ê³¼ë¥¼ í™”ë©´ì— í‘œì‹œ
                displayGuides(analysisResult);

            } catch (error) {
                console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                isAnalyzing = false;
                loading.classList.remove('active');
                analyzeBtn.textContent = 'ë‹¤ì‹œ ë¶„ì„';
                analyzeBtn.style.background = '#4CAF50';
            }
        }

        // ë¹„ë””ì˜¤ í”„ë ˆì„ ìº¡ì²˜
        function captureFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(videoElement, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.8);
        }

        // AI ë¶„ì„ ìˆ˜í–‰ (ë°ëª¨ ë²„ì „)
        async function performAIAnalysis(imageData) {
            // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ì—¬ê¸°ì„œ AI APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
            // ì˜ˆ: Claude API, Google Vision API, TensorFlow.js ë“±

            // ë°ëª¨ìš© ì§€ì—° ì‹œê°„
            await new Promise(resolve => setTimeout(resolve, 2000));

            // ë°ëª¨ìš© ë”ë¯¸ ë°ì´í„°
            // ì‹¤ì œë¡œëŠ” AIê°€ ì¸ì‹í•œ ë²„íŠ¼ì˜ ìœ„ì¹˜ì™€ í…ìŠ¤íŠ¸ë¥¼ ë°˜í™˜
            return [
                {
                    type: 'button',
                    label: 'ì£¼ë¬¸í•˜ê¸°',
                    confidence: 0.95,
                    bounds: {
                        x: 0.3, // í™”ë©´ ë¹„ìœ¨ (0~1)
                        y: 0.7,
                        width: 0.4,
                        height: 0.15
                    },
                    guide: 'ë©”ë‰´ ì„ íƒì´ ì™„ë£Œë˜ì—ˆìœ¼ë©´\nì´ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”'
                },
                {
                    type: 'button',
                    label: 'ë©”ë‰´íŒ',
                    confidence: 0.88,
                    bounds: {
                        x: 0.1,
                        y: 0.3,
                        width: 0.35,
                        height: 0.25
                    },
                    guide: 'ì›í•˜ì‹œëŠ” ë©”ë‰´ë¥¼\nì—¬ê¸°ì„œ ì„ íƒí•˜ì„¸ìš”'
                },
                {
                    type: 'button',
                    label: 'ê²°ì œí•˜ê¸°',
                    confidence: 0.92,
                    bounds: {
                        x: 0.55,
                        y: 0.3,
                        width: 0.35,
                        height: 0.25
                    },
                    guide: 'ì£¼ë¬¸ì´ ëë‚˜ë©´\nì´ ë²„íŠ¼ìœ¼ë¡œ ê²°ì œí•˜ì„¸ìš”'
                }
            ];
        }

        // ì•ˆë‚´ ê°€ì´ë“œ í‘œì‹œ
        function displayGuides(results) {
            // ê¸°ì¡´ ê°€ì´ë“œ ì œê±°
            clearGuides();

            const videoRect = videoElement.getBoundingClientRect();

            results.forEach((item, index) => {
                // í•˜ì´ë¼ì´íŠ¸ ë°•ìŠ¤ ìƒì„±
                const highlightBox = document.createElement('div');
                highlightBox.className = 'highlight-box';
                
                const x = item.bounds.x * videoRect.width;
                const y = item.bounds.y * videoRect.height;
                const width = item.bounds.width * videoRect.width;
                const height = item.bounds.height * videoRect.height;

                highlightBox.style.left = `${x}px`;
                highlightBox.style.top = `${y}px`;
                highlightBox.style.width = `${width}px`;
                highlightBox.style.height = `${height}px`;

                // ì•ˆë‚´ í…ìŠ¤íŠ¸ ë°•ìŠ¤ ìƒì„±
                const guideBox = document.createElement('div');
                guideBox.className = 'guide-box';
                guideBox.textContent = item.guide;
                guideBox.style.whiteSpace = 'pre-line';

                // í…ìŠ¤íŠ¸ ë°•ìŠ¤ ìœ„ì¹˜ (ë²„íŠ¼ ìœ„ìª½ì— ë°°ì¹˜)
                let guideX = x + width / 2;
                let guideY = y - 10; // ë²„íŠ¼ ìœ„ìª½

                // í™”ë©´ ê²½ê³„ ì²´í¬
                guideBox.style.left = `${guideX}px`;
                guideBox.style.top = `${guideY}px`;
                guideBox.style.transform = 'translate(-50%, -100%)';

                // ì• ë‹ˆë©”ì´ì…˜ ì§€ì—°
                guideBox.style.animationDelay = `${index * 0.2}s`;
                highlightBox.style.animationDelay = `${index * 0.2}s`;

                cameraContainer.appendChild(highlightBox);
                cameraContainer.appendChild(guideBox);

                currentGuides.push(highlightBox, guideBox);
            });
        }

        // ê°€ì´ë“œ ì œê±°
        function clearGuides() {
            currentGuides.forEach(element => {
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            });
            currentGuides = [];
        }

        // ì¢…ë£Œ ë²„íŠ¼
        stopBtn.addEventListener('click', () => {
            if (confirm('í‚¤ì˜¤ìŠ¤í¬ ë„ìš°ë¯¸ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                if (videoStream) {
                    videoStream.getTracks().forEach(track => track.stop());
                }
                clearGuides();
                cameraContainer.classList.add('hidden');
                controlPanel.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
        });

        // ìë™ ë¶„ì„ ëª¨ë“œ (ì„ íƒì‚¬í•­)
        let autoAnalyzeInterval = null;
        
        function enableAutoAnalyze() {
            autoAnalyzeInterval = setInterval(async () => {
                if (!isAnalyzing) {
                    await analyzeKioskScreen();
                }
            }, 5000); // 5ì´ˆë§ˆë‹¤ ìë™ ë¶„ì„
        }

        function disableAutoAnalyze() {
            if (autoAnalyzeInterval) {
                clearInterval(autoAnalyzeInterval);
                autoAnalyzeInterval = null;
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>